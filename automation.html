<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="本项目的目标是提供php项目使用Jenkins创建任务的标准模版" />
  <meta name="author" content="Sebastian Bergmann" />
  <title>Jenkins任务模版-PHP版: Automation</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/highlight.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700|Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->
 </head>
 <body>
  <div id="wrap">
   <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
     <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
       <span class="sr-only">Toggle Navigation</span>
       <span class="icon-bar"></span>
       <span class="icon-bar"></span>
       <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Jenkins任务模版-PHP版</a>
     </div>
     <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
       <li><a href="index.html">Home</a></li>
       <li><a href="installation.html">安装</a></li>
       <li class="active"><a href="automation.html">自动化</a></li>
       <li><a href="configuration.html">配置</a></li>
       <li><a href="integration.html">集成</a></li>
       <li><a href="example.html">实例</a></li>
       <li><a href="support.html">支持</a></li>
      </ul>
     </div>
    </div>
   </div>
   <div class="container">
    <div class="page-header">
     <h1>自动化</h1>
    </div>
    <p>利用 <a href="http://ant.apache.org/">Apache Ant</a> 实现构建过程自动化.它依靠 <code>build.xml</code>配置脚本中的各种工具的执行来构建。 (<a href="download/build.xml">下载地址</a>). 配置脚本默认PHP_CodeSniffer 和 PHPMD 的规则定义文件路径为 <code>build/phpcs.xml</code> 和 <code>build/phpmd.xml</code>.</p>
    <pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project name="name-of-project" default="full-build"&gt;
 &lt;!-- By default, we assume all tools to be on the $PATH --&gt;
 &lt;property name="pdepend" value="pdepend"/&gt;
 &lt;property name="phpcpd"  value="phpcpd"/&gt;
 &lt;property name="phpcs"   value="phpcs"/&gt;
 &lt;property name="phpdox"  value="phpdox"/&gt;
 &lt;property name="phploc"  value="phploc"/&gt;
 &lt;property name="phpmd"   value="phpmd"/&gt;
 &lt;property name="phpunit" value="phpunit"/&gt;

 &lt;!-- Use this when the tools are located as PHARs in ${basedir}/build/tools
 &lt;property name="pdepend" value="${basedir}/build/tools/pdepend.phar"/&gt;
 &lt;property name="phpcpd"  value="${basedir}/build/tools/phpcpd.phar"/&gt;
 &lt;property name="phpcs"   value="${basedir}/build/tools/phpcs.phar"/&gt;
 &lt;property name="phpdox"  value="${basedir}/build/tools/phpdox.phar"/&gt;
 &lt;property name="phploc"  value="${basedir}/build/tools/phploc.phar"/&gt;
 &lt;property name="phpmd"   value="${basedir}/build/tools/phpmd.phar"/&gt;
 &lt;property name="phpunit" value="${basedir}/build/tools/phpunit.phar"/&gt; --&gt;

 &lt;!-- Use this when the tools are managed by Composer in ${basedir}/vendor/bin
 &lt;property name="pdepend" value="${basedir}/vendor/bin/pdepend"/&gt;
 &lt;property name="phpcpd"  value="${basedir}/vendor/bin/phpcpd"/&gt;
 &lt;property name="phpcs"   value="${basedir}/vendor/bin/phpcs"/&gt;
 &lt;property name="phpdox"  value="${basedir}/vendor/bin/phpdox"/&gt;
 &lt;property name="phploc"  value="${basedir}/vendor/bin/phploc"/&gt;
 &lt;property name="phpmd"   value="${basedir}/vendor/bin/phpmd"/&gt;
 &lt;property name="phpunit" value="${basedir}/vendor/bin/phpunit"/&gt; --&gt;

 &lt;target name="full-build"
         depends="prepare,static-analysis,phpunit,phpdox,-check-failure"
         description="Performs static analysis, runs the tests, and generates project documentation"/&gt;

 &lt;target name="full-build-parallel"
         depends="prepare,static-analysis-parallel,phpunit,phpdox,-check-failure"
         description="Performs static analysis (executing the tools in parallel), runs the tests, and generates project documentation"/&gt;

 &lt;target name="quick-build"
         depends="prepare,lint,phpunit-no-coverage"
         description="Performs a lint check and runs the tests (without generating code coverage reports)"/&gt;

 &lt;target name="static-analysis"
         depends="lint,phploc-ci,pdepend,phpmd-ci,phpcs-ci,phpcpd-ci"
         description="Performs static analysis" /&gt;

 &lt;!-- Adjust the threadCount attribute's value to the number of CPUs --&gt;
 &lt;target name="static-analysis-parallel"
         description="Performs static analysis (executing the tools in parallel)"&gt;
  &lt;parallel threadCount="2"&gt;
   &lt;sequential&gt;
    &lt;antcall target="pdepend"/&gt;
    &lt;antcall target="phpmd-ci"/&gt;
   &lt;/sequential&gt;
   &lt;antcall target="lint"/&gt;
   &lt;antcall target="phpcpd-ci"/&gt;
   &lt;antcall target="phpcs-ci"/&gt;
   &lt;antcall target="phploc-ci"/&gt;
  &lt;/parallel&gt;
 &lt;/target&gt;

 &lt;target name="clean"
         unless="clean.done"
         description="Cleanup build artifacts"&gt;
  &lt;delete dir="${basedir}/build/api"/&gt;
  &lt;delete dir="${basedir}/build/coverage"/&gt;
  &lt;delete dir="${basedir}/build/logs"/&gt;
  &lt;delete dir="${basedir}/build/pdepend"/&gt;
  &lt;delete dir="${basedir}/build/phpdox"/&gt;
  &lt;property name="clean.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="prepare"
         unless="prepare.done"
         depends="clean"
         description="Prepare for build"&gt;
  &lt;mkdir dir="${basedir}/build/api"/&gt;
  &lt;mkdir dir="${basedir}/build/coverage"/&gt;
  &lt;mkdir dir="${basedir}/build/logs"/&gt;
  &lt;mkdir dir="${basedir}/build/pdepend"/&gt;
  &lt;mkdir dir="${basedir}/build/phpdox"/&gt;
  &lt;property name="prepare.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="lint"
         unless="lint.done"
         description="Perform syntax check of sourcecode files"&gt;
  &lt;apply executable="php" taskname="lint"&gt;
   &lt;arg value="-l" /&gt;

   &lt;fileset dir="${basedir}/src"&gt;
    &lt;include name="**/*.php" /&gt;
    &lt;modified /&gt;
   &lt;/fileset&gt;

   &lt;fileset dir="${basedir}/tests"&gt;
    &lt;include name="**/*.php" /&gt;
    &lt;modified /&gt;
   &lt;/fileset&gt;
  &lt;/apply&gt;

  &lt;property name="lint.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phploc"
         unless="phploc.done"
         description="Measure project size using PHPLOC and print human readable output. Intended for usage on the command line."&gt;
  &lt;exec executable="${phploc}" taskname="phploc"&gt;
   &lt;arg value="--count-tests" /&gt;
   &lt;arg path="${basedir}/src" /&gt;
   &lt;arg path="${basedir}/tests" /&gt;
  &lt;/exec&gt;

  &lt;property name="phploc.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phploc-ci"
         unless="phploc.done"
         depends="prepare"
         description="Measure project size using PHPLOC and log result in CSV and XML format. Intended for usage within a continuous integration environment."&gt;
  &lt;exec executable="${phploc}" taskname="phploc"&gt;
   &lt;arg value="--count-tests" /&gt;
   &lt;arg value="--log-csv" /&gt;
   &lt;arg path="${basedir}/build/logs/phploc.csv" /&gt;
   &lt;arg value="--log-xml" /&gt;
   &lt;arg path="${basedir}/build/logs/phploc.xml" /&gt;
   &lt;arg path="${basedir}/src" /&gt;
   &lt;arg path="${basedir}/tests" /&gt;
  &lt;/exec&gt;

  &lt;property name="phploc.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="pdepend"
         unless="pdepend.done"
         depends="prepare"
         description="Calculate software metrics using PHP_Depend and log result in XML format. Intended for usage within a continuous integration environment."&gt;
  &lt;exec executable="${pdepend}" taskname="pdepend"&gt;
   &lt;arg value="--jdepend-xml=${basedir}/build/logs/jdepend.xml" /&gt;
   &lt;arg value="--jdepend-chart=${basedir}/build/pdepend/dependencies.svg" /&gt;
   &lt;arg value="--overview-pyramid=${basedir}/build/pdepend/overview-pyramid.svg" /&gt;
   &lt;arg path="${basedir}/src" /&gt;
  &lt;/exec&gt;

  &lt;property name="pdepend.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpmd"
         unless="phpmd.done"
         description="Perform project mess detection using PHPMD and print human readable output. Intended for usage on the command line before committing."&gt;
  &lt;exec executable="${phpmd}" taskname="phpmd"&gt;
   &lt;arg path="${basedir}/src" /&gt;
   &lt;arg value="text" /&gt;
   &lt;arg path="${basedir}/build/phpmd.xml" /&gt;
  &lt;/exec&gt;

  &lt;property name="phpmd.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpmd-ci"
         unless="phpmd.done"
         depends="prepare"
         description="Perform project mess detection using PHPMD and log result in XML format. Intended for usage within a continuous integration environment."&gt;
  &lt;exec executable="${phpmd}" taskname="phpmd"&gt;
   &lt;arg path="${basedir}/src" /&gt;
   &lt;arg value="xml" /&gt;
   &lt;arg path="${basedir}/build/phpmd.xml" /&gt;
   &lt;arg value="--reportfile" /&gt;
   &lt;arg path="${basedir}/build/logs/pmd.xml" /&gt;
  &lt;/exec&gt;

  &lt;property name="phpmd.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpcs"
         unless="phpcs.done"
         description="Find coding standard violations using PHP_CodeSniffer and print human readable output. Intended for usage on the command line before committing."&gt;
  &lt;exec executable="${phpcs}" taskname="phpcs"&gt;
   &lt;arg value="--standard=PSR2" /&gt;
   &lt;arg value="--extensions=php" /&gt;
   &lt;arg value="--ignore=autoload.php" /&gt;
   &lt;arg path="${basedir}/src" /&gt;
   &lt;arg path="${basedir}/tests" /&gt;
  &lt;/exec&gt;

  &lt;property name="phpcs.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpcs-ci"
         unless="phpcs.done"
         depends="prepare"
         description="Find coding standard violations using PHP_CodeSniffer and log result in XML format. Intended for usage within a continuous integration environment."&gt;
  &lt;exec executable="${phpcs}" output="/dev/null" taskname="phpcs"&gt;
   &lt;arg value="--report=checkstyle" /&gt;
   &lt;arg value="--report-file=${basedir}/build/logs/checkstyle.xml" /&gt;
   &lt;arg value="--standard=PSR2" /&gt;
   &lt;arg value="--extensions=php" /&gt;
   &lt;arg value="--ignore=autoload.php" /&gt;
   &lt;arg path="${basedir}/src" /&gt;
   &lt;arg path="${basedir}/tests" /&gt;
  &lt;/exec&gt;

  &lt;property name="phpcs.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpcpd"
         unless="phpcpd.done"
         description="Find duplicate code using PHPCPD and print human readable output. Intended for usage on the command line before committing."&gt;
  &lt;exec executable="${phpcpd}" taskname="phpcpd"&gt;
   &lt;arg path="${basedir}/src" /&gt;
  &lt;/exec&gt;

  &lt;property name="phpcpd.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpcpd-ci"
         unless="phpcpd.done"
         depends="prepare"
         description="Find duplicate code using PHPCPD and log result in XML format. Intended for usage within a continuous integration environment."&gt;
  &lt;exec executable="${phpcpd}" taskname="phpcpd"&gt;
   &lt;arg value="--log-pmd" /&gt;
   &lt;arg path="${basedir}/build/logs/pmd-cpd.xml" /&gt;
   &lt;arg path="${basedir}/src" /&gt;
  &lt;/exec&gt;

  &lt;property name="phpcpd.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpunit"
         unless="phpunit.done"
         depends="prepare"
         description="Run unit tests with PHPUnit"&gt;
  &lt;exec executable="${phpunit}" resultproperty="result.phpunit" taskname="phpunit"&gt;
   &lt;arg value="--configuration"/&gt;
   &lt;arg path="${basedir}/build/phpunit.xml"/&gt;
  &lt;/exec&gt;

  &lt;property name="phpunit.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpunit-no-coverage"
         unless="phpunit.done"
         depends="prepare"
         description="Run unit tests with PHPUnit (without generating code coverage reports)"&gt;
  &lt;exec executable="${phpunit}" failonerror="true" taskname="phpunit"&gt;
   &lt;arg value="--configuration"/&gt;
   &lt;arg path="${basedir}/build/phpunit.xml"/&gt;
   &lt;arg value="--no-coverage"/&gt;
  &lt;/exec&gt;

  &lt;property name="phpunit.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="phpdox"
         unless="phpdox.done"
         depends="phploc-ci,phpcs-ci,phpmd-ci"
         description="Generate project documentation using phpDox"&gt;
  &lt;exec executable="${phpdox}" dir="${basedir}/build" taskname="phpdox"/&gt;

  &lt;property name="phpdox.done" value="true"/&gt;
 &lt;/target&gt;

 &lt;target name="-check-failure"&gt;
  &lt;fail message="PHPUnit did not finish successfully"&gt;
   &lt;condition&gt;
    &lt;not&gt;
     &lt;equals arg1="${result.phpunit}" arg2="0"/&gt;
    &lt;/not&gt;
   &lt;/condition&gt;
  &lt;/fail&gt;
 &lt;/target&gt;
&lt;/project&gt;</code></pre>
    <p>下面是对上面的 <code>build.xml</code> (<a href="download/build.xml">下载</a>) 脚本里会直接执行的命令的一览:</p>
    <ul>
     <li><p><code>full-build</code> 是默认构建目标. 构建工具对应的xml文件都应该在默认位置。运行全量构建需要时间较长，适用于发nightly版本</p></li>
     <li><p><code>full-build-parallel</code> 跟 <code>full-build</code> (如上) 一样，除了会在 parallel 里执行静态分析工具。即使有多核CPU，运行这个也会花不少时间，适用于发nightly版本</p></li>
     <li><p><code>quick-build</code> 是一个指定每次push到代码库时自动触发执行任务的构建目标。它会坐lint检查并运行测试用例(不生成代码覆盖率报告).</p></li>
     <li><p><code>clean</code> 用于清理构建文件 (logfiles, etc. that are produced during the build).</p></li>
     <li><p><code>lint</code> 用于对代码做语法检查，基于 <code>php -l</code>.</p> 可以在提交代码前做</li>
     <li><p><code>phpcs</code> 用于发现代码标准支持程度并以便于阅读的格式输出，可以在提交代码前做</p></li>
     <li><p><code>phpcpd</code> 用于发现重复代码并以便于阅读的格式输出，可以在提交代码前做</p></li>
     <li><p><code>phpmd</code> 用于优化项目检测输出，可以在提交代码前做</p></li>
     <li><p><code>phpunit</code> 运行单元测试</p> 可以在提交代码前做</li>
     <li><p><code>phpdox</code> 创建项目文档</p></li>
     <li><p><code>phploc</code> 检测项目大小</p></li>
    </ul>
    <p>除了上面列出的任务外，其他任务也可以直接调用，但是不建议这么用</p>
    <p>执行 <code>build.xml</code> 脚本将会生成如下<code>build</code>目录:</p>
    <pre>build
|-- api ...
|-- coverage ...
`-- logs
    |-- checkstyle.xml
    |-- clover.xml
    |-- crap4j.xml
    |-- jdepend.xml
    |-- junit.xml
    |-- phploc.csv
    |-- pmd-cpd.xml
    `-- pmd.xml</pre>
    <p>这些构建过程都是Jenkins执行的.</p>
   </div>
  </div>
  <div id="footer">
   <div class="container">
    <p class="text-muted">The "<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type"><a xmlns:cc="http://creativecommons.org/ns#" href="http://jenkins-php.org/" property="cc:attributionName" rel="cc:attributionURL">Jenkins任务模版-PHP版</a></span>" by <a href="http://sebastian-bergmann.de/">Sebastian Bergmann</a> and his contributors is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.</p>
   </div>
  </div>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/highlight.min.js"></script>
  <script type="text/javascript">
  hljs.initHighlightingOnLoad();

  var _paq = _paq || [];
  _paq.push(["trackPageView"]);
  _paq.push(["enableLinkTracking"]);

  (function() {
    var u=(("https:" == document.location.protocol) ? "https" : "http") + "://piwik.sebastian-bergmann.de/";
    _paq.push(["setTrackerUrl", u+"piwik.php"]);
    _paq.push(["setSiteId", "6"]);
    var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";
    g.defer=true; g.async=true; g.src=u+"piwik.js"; s.parentNode.insertBefore(g,s);
  })();
  </script>
 </body>
</html>

